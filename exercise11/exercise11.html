<!doctype html>

<html lang="en">
<head>
    <meta charset="utf-8">

    <title>Inheritance</title>

    <link rel="stylesheet" href="../styles.css">
    <script src="../drawing.js"></script>
    <script src="../objects.js"></script>
        <!--[if lt IE 9]>
        <script
        src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.js">
        </script>
        <![endif]-->

</head>

<body>
  <h1>Inheritance</h1>  
  <canvas tabindex="1" id="asteroids" width="600" height="600"></canvas>
  <script>
    'use strict';
    let context = document.getElementById("asteroids").getContext("2d");
    let asteroids = [];
    let guide = true;

    for (let i = 0; i < 4; i++) {
      let asteroid = new Asteroid(
        10000,
        Math.random() * context.canvas.width,
        Math.random() * context.canvas.height
      );
      asteroid.push(Math.random() * 2 * Math.PI, 2000, 60)
      asteroid.twist((Math.random() - 0.5) * 500, 60);
      asteroids.push(asteroid)
    }

    let ship = new Ship(context.canvas.width / 2, context.canvas.height / 2,
      1000);

    let projectiles = [];

    let draw = () => {
      context.clearRect(0, 0, context.canvas.width, context.canvas.height)
      draw_grid(context);
      asteroids.forEach((asteroid) => {
        asteroid.draw(context, guide)
      })
      ship.draw(context, guide)
      projectiles.forEach((p) => {
        p.draw(context)
      })
    }

    let update = (elapsed) => {
      asteroids.forEach((asteroid) => {
        asteroid.update(elapsed, context)
      })
      ship.update(elapsed, context);
      projectiles.forEach((p, i, projectiles) => {
        p.update(elapsed, context);
        if(p.life <= 0) {
          projectiles.splice(i, 1);
        }
      })
      if(ship.trigger && ship.loaded) {
        projectiles.push(ship.projectile(elapsed));
      }
    }

    let keyHandler = (e, value) => {
      let nothingHandled = false;
      switch(e.key || e.keyCode) {
        case "ArrowUp":
        case 38:
          ship.thrusterOn = value;
          break;
        case "ArrowLeft":
        case 37:
          ship.leftThruster = value;
          break;
        case "ArrowRight":
        case 39:
          ship.rightThruster = value;
          break;
        case " ":
        case 32:
          ship.trigger = value;
          break;
        case "g":
        case 71:
          if(value) guide = !guide;
        default:
          nothingHandled = true;
      }
      if (!nothingHandled) e.preventDefault();
    }

    context.canvas.addEventListener("keydown", (e) => {
      keyHandler(e, true);
    }, true);

    context.canvas.addEventListener("keyup", (e) => {
      keyHandler(e, false);
    }, true);

    let previous;
    let frame = (timestamp) => {
      if (!previous) previous = timestamp;
      let elapsed = timestamp - previous;
      context.clearRect(0, 0, context.canvas.width, context.canvas.height);
      update(elapsed/1000);
      draw(context);
      previous = timestamp;
      window.requestAnimationFrame(frame);
    }
    window.requestAnimationFrame(frame);
  </script>
</body>
</html>

